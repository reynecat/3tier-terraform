%%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '14px'}}}%%
flowchart TB
    %% ========================================
    %% GLOBAL SERVICES (AWS Edge / us-east-1)
    %% ========================================
    subgraph Global["<b>AWS Global Services</b>"]
        direction TB

        subgraph Route53Box["Route53"]
            Route53[("Route53<br/>DNS")]
        end

        subgraph CloudFrontBox["CloudFront CDN"]
            CF["CloudFront<br/>Distribution"]
            OriginGroup["Origin Group<br/>(Failover)"]
        end

        subgraph ACMBox["ACM (us-east-1)"]
            ACM["SSL/TLS Certificate<br/>*.example.com"]
        end
    end

    %% ========================================
    %% AWS REGIONAL (ap-northeast-2)
    %% ========================================
    subgraph AWSRegion["<b>AWS Regional Services (ap-northeast-2 Seoul)</b>"]
        direction TB

        subgraph VPC["VPC: 10.0.0.0/16"]
            direction TB

            %% PUBLIC TIER
            subgraph PublicTier["<b>Public Tier</b>"]
                direction LR
                subgraph PubAZ1["AZ-a: 10.0.1.0/24"]
                    IGW["Internet<br/>Gateway"]
                    NAT["NAT Gateway<br/>+ Elastic IP"]
                    ALB["Application<br/>Load Balancer<br/>(HTTP:80, HTTPS:443)"]
                end
                subgraph PubAZ2["AZ-c: 10.0.2.0/24"]
                    ALB2["ALB<br/>(Cross-Zone)"]
                end
            end

            %% WEB TIER
            subgraph WebTier["<b>Web Tier (Presentation Layer)</b>"]
                direction LR
                subgraph WebAZ1["AZ-a: 10.0.11.0/24"]
                    WebNode1["EKS Node<br/>t3.medium"]
                    WebPod1["Nginx Pod<br/>:8080"]
                end
                subgraph WebAZ2["AZ-c: 10.0.12.0/24"]
                    WebNode2["EKS Node<br/>t3.medium"]
                    WebPod2["Nginx Pod<br/>:8080"]
                end
            end

            %% WAS TIER
            subgraph WASTier["<b>WAS Tier (Business Logic Layer)</b>"]
                direction LR
                subgraph WASAZ1["AZ-a: 10.0.21.0/24"]
                    WASNode1["EKS Node<br/>t3.medium"]
                    WASPod1["Spring Boot<br/>PetClinic :8080"]
                    BackupEC2["Backup EC2<br/>t3.small"]
                end
                subgraph WASAZ2["AZ-c: 10.0.22.0/24"]
                    WASNode2["EKS Node<br/>t3.medium"]
                    WASPod2["Spring Boot<br/>PetClinic :8080"]
                end
            end

            %% DATABASE TIER
            subgraph DBTier["<b>Database Tier (Data Layer)</b>"]
                direction LR
                subgraph DBAZ1["AZ-a: 10.0.31.0/24"]
                    RDSPrimary[("RDS MySQL 8.0<br/>Primary<br/>db.t3.medium")]
                end
                subgraph DBAZ2["AZ-c: 10.0.32.0/24"]
                    RDSStandby[("RDS MySQL 8.0<br/>Standby<br/>(Multi-AZ Sync)")]
                end
            end
        end

        %% EKS Control Plane
        subgraph EKSControl["EKS Control Plane"]
            EKS["EKS Cluster v1.34<br/>+ OIDC Provider"]
        end

        %% Secrets Manager
        subgraph SecretsBox["Secrets Manager"]
            Secrets["backup-credentials<br/>(RDS, Azure keys)"]
        end
    end

    %% ========================================
    %% AZURE DR SITE (Korea Central)
    %% ========================================
    subgraph AzureRegion["<b>Azure DR Site (Korea Central)</b>"]
        direction TB

        subgraph AzureVNet["VNet: 172.16.0.0/16"]
            direction TB

            %% Stage 1: Always On
            subgraph Stage1["<b>Stage 1: Pilot Light (Always Active)</b>"]
                subgraph BlobSubnet["Storage Account"]
                    BlobBackup["Blob Container<br/>mysql-backups<br/>(30-day lifecycle)"]
                    BlobWeb["Static Website<br/>Maintenance Page"]
                end
            end

            %% Stage 2: Emergency
            subgraph Stage2["<b>Stage 2: Emergency Response</b>"]
                subgraph AppGWSub["snet-appgw: 172.16.1.0/24"]
                    AppGW["Application<br/>Gateway<br/>Standard_v2"]
                end
                subgraph AzureDBSub["snet-db: 172.16.31.0/24"]
                    AzureMySQL[("MySQL Flexible<br/>Server 8.0<br/>B_Standard_B2s")]
                end
            end

            %% Stage 3: Full Failover
            subgraph Stage3["<b>Stage 3: Full Failover</b>"]
                subgraph AKSSub["snet-aks: 172.16.41.0/24"]
                    AKS["AKS Cluster<br/>v1.28"]
                    AKSNodes["Node Pool<br/>Standard_D2s_v3<br/>(2-5 nodes)"]
                end
            end
        end
    end

    %% ========================================
    %% CONNECTIONS
    %% ========================================

    %% User Flow
    Users((Users)) --> Route53
    Route53 --> CF
    ACM -.->|TLS Certificate| CF
    CF --> OriginGroup

    %% Primary Path (AWS)
    OriginGroup -->|Primary| ALB
    ALB --> WebPod1 & WebPod2
    WebPod1 & WebPod2 --> WASPod1 & WASPod2
    WASPod1 & WASPod2 -->|:3306| RDSPrimary
    RDSPrimary <-.->|Sync Replication| RDSStandby

    %% Failover Path (Azure)
    OriginGroup -.->|"Failover<br/>(5xx errors)"| BlobWeb
    BlobWeb -.-> AppGW
    AppGW -.-> AKS
    AKS -.-> AzureMySQL

    %% Backup Flow
    BackupEC2 -->|mysqldump| RDSPrimary
    BackupEC2 -->|HTTPS Upload| BlobBackup
    Secrets -->|Credentials| BackupEC2
    BlobBackup -.->|Restore| AzureMySQL

    %% NAT Gateway Flow
    NAT -->|Outbound| WebNode1 & WebNode2 & WASNode1 & WASNode2
    IGW --> NAT

    %% EKS Management
    EKS --> WebNode1 & WebNode2 & WASNode1 & WASNode2

    %% ========================================
    %% STYLING
    %% ========================================

    %% Global Services - Yellow/Gold
    style Global fill:#FFF8E1,stroke:#F9A825,stroke-width:3px
    style Route53Box fill:#FFE082,stroke:#F9A825
    style CloudFrontBox fill:#FFE082,stroke:#F9A825
    style ACMBox fill:#FFE082,stroke:#F9A825

    %% AWS Region - Blue
    style AWSRegion fill:#E3F2FD,stroke:#1565C0,stroke-width:3px
    style VPC fill:#BBDEFB,stroke:#1976D2,stroke-width:2px

    %% 3-Tier Colors
    style PublicTier fill:#FFF3E0,stroke:#EF6C00,stroke-width:2px
    style PubAZ1 fill:#FFE0B2,stroke:#F57C00
    style PubAZ2 fill:#FFE0B2,stroke:#F57C00

    style WebTier fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px
    style WebAZ1 fill:#C8E6C9,stroke:#388E3C
    style WebAZ2 fill:#C8E6C9,stroke:#388E3C

    style WASTier fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style WASAZ1 fill:#F8BBD9,stroke:#D81B60
    style WASAZ2 fill:#F8BBD9,stroke:#D81B60

    style DBTier fill:#E0F2F1,stroke:#00695C,stroke-width:2px
    style DBAZ1 fill:#B2DFDB,stroke:#00897B
    style DBAZ2 fill:#B2DFDB,stroke:#00897B

    %% Azure Region - Purple
    style AzureRegion fill:#F3E5F5,stroke:#7B1FA2,stroke-width:3px
    style AzureVNet fill:#E1BEE7,stroke:#8E24AA,stroke-width:2px
    style Stage1 fill:#D1C4E9,stroke:#5E35B1
    style Stage2 fill:#C5CAE9,stroke:#3949AB
    style Stage3 fill:#BBDEFB,stroke:#1E88E5

    %% EKS & Secrets
    style EKSControl fill:#E3F2FD,stroke:#1565C0
    style SecretsBox fill:#FFF9C4,stroke:#FBC02D
