# Jenkins Helm Chart Values for AWS EKS
# helm install jenkins jenkins/jenkins -f jenkins-values.yaml -n jenkins

controller:
  componentName: "jenkins-controller"
  image: "jenkins/jenkins"
  tag: "2.426.2-lts-jdk17"
  imagePullPolicy: "IfNotPresent"

  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"

  # Jenkins URL
  jenkinsUrl: "https://jenkins.example.com"

  # Admin 사용자 설정
  adminUser: "admin"
  # adminPassword는 Kubernetes Secret에서 관리

  # 서비스 설정
  serviceType: LoadBalancer
  serviceAnnotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"

  # Ingress 설정 (ALB 사용 시)
  ingress:
    enabled: true
    apiVersion: "networking.k8s.io/v1"
    annotations:
      kubernetes.io/ingress.class: alb
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:ACCOUNT_ID:certificate/CERT_ID
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
    hostName: jenkins.example.com
    tls:
      - hosts:
          - jenkins.example.com

  # JCasC (Jenkins Configuration as Code)
  JCasC:
    defaultConfig: true
    configScripts:
      welcome-message: |
        jenkins:
          systemMessage: "Welcome to Jenkins for AWS EKS CI/CD Pipeline"

      credentials: |
        credentials:
          system:
            domainCredentials:
              - credentials:
                  - usernamePassword:
                      scope: GLOBAL
                      id: "github-credentials"
                      username: "${GITHUB_USERNAME}"
                      password: "${GITHUB_TOKEN}"
                      description: "GitHub Credentials"
                  - string:
                      scope: GLOBAL
                      id: "argocd-token"
                      secret: "${ARGOCD_TOKEN}"
                      description: "ArgoCD Auth Token"
                  - string:
                      scope: GLOBAL
                      id: "sonarqube-token"
                      secret: "${SONARQUBE_TOKEN}"
                      description: "SonarQube Token"
                  - string:
                      scope: GLOBAL
                      id: "slack-token"
                      secret: "${SLACK_TOKEN}"
                      description: "Slack Webhook Token"

      jobs: |
        jobs:
          - script: >
              multibranchPipelineJob('pocketbank') {
                  branchSources {
                      github {
                          id('pocketbank-github')
                          scanCredentialsId('github-credentials')
                          repoOwner('your-org')
                          repository('spring-pocketbank')
                      }
                  }
                  orphanedItemStrategy {
                      discardOldItems {
                          numToKeep(10)
                      }
                  }
              }

      sonarqube: |
        unclassified:
          sonarGlobalConfiguration:
            buildWrapperEnabled: true
            installations:
              - name: "SonarQube"
                serverUrl: "http://sonarqube:9000"
                credentialsId: "sonarqube-token"

  # 플러그인 설치
  installPlugins:
    - kubernetes:4029.v5712230ccb_f8
    - workflow-aggregator:596.v8c21c963d92d
    - git:5.2.0
    - github:1.37.3.1
    - github-branch-source:1775.v50b_d9fc54d2c
    - configuration-as-code:1775.v810dc950b_514
    - sonar:2.16.1
    - slack:684.v833089650554
    - docker-workflow:572.v950f58993843
    - aws-credentials:218.v1b_e9466ec5da_
    - pipeline-aws:1.44
    - kubernetes-credentials-provider:1.234.vf3013b_35f5b_a
    - blueocean:1.27.9
    - job-dsl:1.87

  # ServiceAccount 설정
  serviceAccount:
    create: true
    name: jenkins
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/jenkins-eks-role

# Agent 설정
agent:
  enabled: true
  namespace: jenkins
  containerCap: 10
  podRetention: "Never"
  showRawYaml: true

  resources:
    requests:
      cpu: "512m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

  # Agent Pod Templates
  podTemplates:
    maven: |
      - name: maven
        label: maven
        containers:
          - name: maven
            image: maven:3.9-eclipse-temurin-17
            command: "/bin/sh -c"
            args: "cat"
            ttyEnabled: true
            resourceRequestCpu: "500m"
            resourceRequestMemory: "1Gi"

    docker: |
      - name: docker
        label: docker
        containers:
          - name: docker
            image: docker:24-dind
            privileged: true
            resourceRequestCpu: "500m"
            resourceRequestMemory: "512Mi"

# 영구 볼륨 설정
persistence:
  enabled: true
  storageClass: "gp3"
  size: "50Gi"

# RBAC 설정
rbac:
  create: true
  readSecrets: true

# ServiceAccount
serviceAccountAgent:
  create: true
  name: jenkins-agent
