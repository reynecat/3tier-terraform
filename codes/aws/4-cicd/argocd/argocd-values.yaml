# ArgoCD Helm Chart Values for AWS EKS
# helm install argocd argo/argo-cd -f argocd-values.yaml -n argocd

global:
  image:
    repository: quay.io/argoproj/argocd
    tag: "v2.9.3"

# Redis HA 설정
redis-ha:
  enabled: true

# Controller 설정
controller:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring

# Server 설정
server:
  replicas: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Ingress 설정 (ALB)
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: alb
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:ACCOUNT_ID:certificate/CERT_ID
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/backend-protocol: HTTPS
    hosts:
      - argocd.example.com
    tls:
      - hosts:
          - argocd.example.com

  # Service 설정
  service:
    type: ClusterIP

  # 추가 명령행 인자
  extraArgs:
    - --insecure  # Ingress에서 TLS 종료 시 필요

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Repo Server 설정
repoServer:
  replicas: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# ApplicationSet Controller
applicationSet:
  enabled: true
  replicas: 2

# Notifications Controller
notifications:
  enabled: true

  argocdUrl: https://argocd.example.com

  # Slack 알림 설정
  notifiers:
    service.slack: |
      token: $slack-token

  templates:
    template.app-deployed: |
      message: |
        Application {{.app.metadata.name}} is now deployed.
        Revision: {{.app.status.sync.revision}}
        Health: {{.app.status.health.status}}
    template.app-sync-failed: |
      message: |
        Application {{.app.metadata.name}} sync failed!
        Error: {{.app.status.operationState.message}}
    template.app-health-degraded: |
      message: |
        Application {{.app.metadata.name}} health is degraded.
        Health: {{.app.status.health.status}}

  triggers:
    trigger.on-deployed: |
      - when: app.status.operationState.phase in ['Succeeded']
        send: [app-deployed]
    trigger.on-sync-failed: |
      - when: app.status.operationState.phase in ['Error', 'Failed']
        send: [app-sync-failed]
    trigger.on-health-degraded: |
      - when: app.status.health.status == 'Degraded'
        send: [app-health-degraded]

  subscriptions:
    - recipients:
        - slack:deployments
      triggers:
        - on-deployed
        - on-sync-failed
        - on-health-degraded

# Dex 설정 (SSO)
dex:
  enabled: true

# ConfigMap 설정
configs:
  cm:
    # URL 설정
    url: https://argocd.example.com

    # Repository 설정
    repositories: |
      - url: https://github.com/your-org/pocketbank-gitops.git
        passwordSecret:
          name: github-secret
          key: password
        usernameSecret:
          name: github-secret
          key: username

    # SSO 설정 (GitHub OAuth)
    dex.config: |
      connectors:
        - type: github
          id: github
          name: GitHub
          config:
            clientID: $dex-github-client-id
            clientSecret: $dex-github-client-secret
            orgs:
              - name: your-org

    # Resource 추적 방법
    resource.customizations: |
      admissionregistration.k8s.io/MutatingWebhookConfiguration:
        ignoreDifferences: |
          jsonPointers:
            - /webhooks/0/clientConfig/caBundle

    # Kustomize 설정
    kustomize.buildOptions: --enable-helm

  # RBAC 설정
  rbac:
    policy.default: role:readonly
    policy.csv: |
      p, role:org-admin, applications, *, */*, allow
      p, role:org-admin, clusters, get, *, allow
      p, role:org-admin, repositories, *, *, allow
      p, role:org-admin, logs, get, *, allow
      p, role:org-admin, exec, create, */*, allow
      g, your-org:devops-team, role:org-admin
      g, your-org:developers, role:readonly

  # Secret 설정
  secret:
    createSecret: true
    # admin 비밀번호는 별도 설정

  params:
    server.insecure: true  # Ingress TLS 종료 시
