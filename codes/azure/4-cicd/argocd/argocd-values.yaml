# ArgoCD Helm Chart Values for Azure AKS
# helm install argocd argo/argo-cd -f argocd-values.yaml -n argocd

global:
  image:
    repository: quay.io/argoproj/argocd
    tag: "v2.9.3"

# Redis HA 설정
redis-ha:
  enabled: true

# Controller 설정
controller:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring

# Server 설정
server:
  replicas: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Ingress 설정 (Application Gateway)
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: azure/application-gateway
      appgw.ingress.kubernetes.io/ssl-redirect: "true"
      appgw.ingress.kubernetes.io/backend-protocol: "https"
      appgw.ingress.kubernetes.io/health-probe-path: "/healthz"
    hosts:
      - argocd.bloberry.cloud
    tls:
      - hosts:
          - argocd.bloberry.cloud
        secretName: argocd-tls

  service:
    type: ClusterIP

  extraArgs:
    - --insecure

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Repo Server 설정
repoServer:
  replicas: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# ApplicationSet Controller
applicationSet:
  enabled: true
  replicas: 2

# Notifications Controller
notifications:
  enabled: true
  argocdUrl: https://argocd.bloberry.cloud

  notifiers:
    service.slack: |
      token: $slack-token
    service.teams: |
      webhookUrl: $teams-webhook-url

  templates:
    template.app-deployed: |
      message: |
        Application {{.app.metadata.name}} deployed to Azure AKS.
        Revision: {{.app.status.sync.revision}}
        Health: {{.app.status.health.status}}
    template.app-sync-failed: |
      message: |
        Application {{.app.metadata.name}} sync failed on Azure!
        Error: {{.app.status.operationState.message}}

  triggers:
    trigger.on-deployed: |
      - when: app.status.operationState.phase in ['Succeeded']
        send: [app-deployed]
    trigger.on-sync-failed: |
      - when: app.status.operationState.phase in ['Error', 'Failed']
        send: [app-sync-failed]

  subscriptions:
    - recipients:
        - slack:deployments
        - teams:deployments
      triggers:
        - on-deployed
        - on-sync-failed

# Dex 설정 (Azure AD SSO)
dex:
  enabled: true

# ConfigMap 설정
configs:
  cm:
    url: https://argocd.bloberry.cloud

    repositories: |
      - url: https://github.com/your-org/pocketbank-gitops.git
        passwordSecret:
          name: github-secret
          key: password
        usernameSecret:
          name: github-secret
          key: username

    # Azure AD SSO 설정
    dex.config: |
      connectors:
        - type: microsoft
          id: azure-ad
          name: Azure AD
          config:
            clientID: $dex-azure-client-id
            clientSecret: $dex-azure-client-secret
            tenant: your-tenant-id
            redirectURI: https://argocd.bloberry.cloud/api/dex/callback
            groups:
              - DevOps-Team
              - Developers

    kustomize.buildOptions: --enable-helm

  rbac:
    policy.default: role:readonly
    policy.csv: |
      p, role:org-admin, applications, *, */*, allow
      p, role:org-admin, clusters, get, *, allow
      p, role:org-admin, repositories, *, *, allow
      g, DevOps-Team, role:org-admin
      g, Developers, role:readonly

  secret:
    createSecret: true

  params:
    server.insecure: true
