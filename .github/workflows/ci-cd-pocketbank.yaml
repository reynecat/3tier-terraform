name: CI/CD - PocketBank

on:
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  AZURE_RESOURCE_GROUP: rg-dr-blue
  AKS_CLUSTER_NAME: aks-dr-blue

jobs:
  update-manifests:
    name: Update Kubernetes Manifests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update web image tag
        run: |
          TAG=${{ github.event.inputs.image_tag }}
          sed -i "s|image: cloud039/pocketbank-web:.*|image: cloud039/pocketbank-web:${TAG}|g" k8s/web/deployment.yaml

      - name: Update was image tag
        run: |
          TAG=${{ github.event.inputs.image_tag }}
          sed -i "s|image: cloud039/pocketbank-was:.*|image: cloud039/pocketbank-was:${TAG}|g" k8s/was/deployment.yaml

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add k8s/
          git commit -m "Update PocketBank images to ${{ github.event.inputs.image_tag }}" || echo "No changes to commit"
          git push

  verify-deployment:
    name: Verify AKS Deployment
    runs-on: ubuntu-latest
    needs: [update-manifests]
    if: always()

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting for ArgoCD to sync changes..."
          sleep 30

      - name: Check deployment status
        run: |
          echo "=== PocketBank Web Deployment ==="
          kubectl rollout status deployment/pocketbank-web -n pocketbank --timeout=5m

          echo ""
          echo "=== PocketBank WAS Deployment ==="
          kubectl rollout status deployment/pocketbank-was -n pocketbank --timeout=5m

      - name: Get service endpoints
        run: |
          echo "=== Services ==="
          kubectl get svc -n pocketbank

          echo ""
          echo "=== Pods ==="
          kubectl get pods -n pocketbank

      - name: Test web endpoint
        run: |
          WEB_IP=$(kubectl get svc pocketbank-web -n pocketbank -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Testing web endpoint: http://$WEB_IP"
          curl -I http://$WEB_IP || echo "Web endpoint not ready yet"

      - name: Update Application Gateway backend
        run: |
          WEB_IP=$(kubectl get svc pocketbank-web -n pocketbank -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          az network application-gateway address-pool update \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --gateway-name appgw-blue \
            --name aks-backend-pool \
            --servers $WEB_IP

          echo "Application Gateway updated to point to: $WEB_IP"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [verify-deployment]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.verify-deployment.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
