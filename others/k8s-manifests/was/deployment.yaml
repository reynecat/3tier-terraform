# others/k8s-manifests/was/deployment.yaml
# WAS Tier (Spring Boot) Deployment

apiVersion: apps/v1
kind: Deployment
metadata:
  name: was-spring
  namespace: was
  labels:
    app: was-spring
    tier: was
spec:
  replicas: 2
  selector:
    matchLabels:
      app: was-spring
  template:
    metadata:
      labels:
        app: was-spring
        tier: was
    spec:
      # Node Selector: WAS Tier 노드에만 배포
      nodeSelector:
        tier: was
      
      containers:
      - name: spring-boot
        # DockerHub 이미지 (여기를 실제 이미지로 수정하세요!)
        image: c1oud039/test:latest
        
        ports:
        - containerPort: 8080
          name: http
        
        # 환경 변수
        env:
         - name: PORT
          value: "8080"
        # 데이터베이스 연결 (Secret에서 가져옴)
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:mysql://$(DB_HOST):3306/$(DB_NAME)?useSSL=true&requireSSL=false"
        
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: host
        
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: database
        
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: username
        
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: password
        
        # JVM 옵션
        - name: JAVA_OPTS
          value: "-Xms512m -Xmx1024m -XX:+UseG1GC"
        
        # Spring Profile
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        
        # Health Check
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # 리소스 제한
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
        
        # 로그 볼륨
        volumeMounts:
        - name: app-logs
          mountPath: /app/logs
      
      volumes:
      - name: app-logs
        emptyDir: {}
---
# DB Credentials Secret (예시 - 실제로는 Terraform으로 생성)
# kubectl create secret generic db-credentials \
#   --from-literal=host=rds-endpoint.ap-northeast-2.rds.amazonaws.com \
#   --from-literal=database=petclinic \
#   --from-literal=username=admin \
#   --from-literal=password=your-password \
#   -n was
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
  namespace: was
type: Opaque
stringData:
  host: "REPLACE_WITH_RDS_ENDPOINT"
  database: "petclinic"
  username: "admin"
  password: "REPLACE_WITH_PASSWORD"
